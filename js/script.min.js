const url=new URL('https://studika.ru/api/areas');const choiseArea=document.querySelector('#choise-template').content;const sidebarButton=document.querySelector('#hamburger');const sidebarContainer=document.querySelector('.mobile-menu-container');const overlay=sidebarContainer.querySelector('.mobile-menu-overlay');const menu=sidebarContainer.querySelector('.mobile-menu-content');const hightEdButton=menu.querySelector('[data-type=menu-hight]');const middleEdButton=menu.querySelector('[data-type=menu-middle]');const hightEdMenu=menu.querySelector(`#${hightEdButton.dataset.type}`);const middleEdMenu=menu.querySelector(`#${middleEdButton.dataset.type}`);const searchButton=document.querySelector('#city-search-button');const searchDisplay=document.querySelector('#city-search-window');const choisedCities=document.querySelector('.search-choised');const searchClear=searchDisplay.querySelector('.city-search-clear');const searchInput=searchDisplay.querySelector('.city-search');const suggestions=searchDisplay.querySelector('.all-city-loaded');const selectedArea=searchDisplay.querySelector('.city-selected');const saveButton=searchDisplay.querySelector('#save-search-list');function append(parent,el){return parent.appendChild(el)}function createNode(element){return document.createElement(element)}const removeArrayElement=(array,value)=>{return array.filter(el=>el.id!=value)};function clearPage(placeWhereDelete,classToDelete){let listToDelete=placeWhereDelete.querySelectorAll(classToDelete);listToDelete.forEach(e=>e.remove())}async function getData(){const array=[];const response=await fetch(url,{method:'POST',});const result=await response.json();array.push(...result);return array}function getCities(array){const citiesList=[];array.forEach(element=>{if(element.type==='area')citiesList.push(...element.cities)});return citiesList}async function main(){const cookieName='search';const areas=await getData();const cities=getCities(areas);const data=areas.concat(cities);data.sort((a,b)=>Number(a.id)-Number(b.id));let choiseList=[];function getCookiesList(array){return array.map(item=>{return data.find((el)=>el.name==item)})}if(document.cookie){let request=document.cookie.slice(cookieName.length+1);choisedCities.textContent=request;let requestList=request.split(', ');choiseList.push(...getCookiesList(requestList));console.log(choiseList);choiseList.forEach(choise=>createChoiseItem(choise))}else{choisedCities.textContent='Любой регион'}data.forEach(area=>{const item=createListItem(area);append(suggestions,item)});searchButton.addEventListener('click',()=>{if(searchDisplay.classList.contains('.active')){searchDisplay.classList.add('closed');setTimeout(()=>searchDisplay.classList.toggle('active'),500)}else{searchDisplay.classList.toggle('active');searchDisplay.classList.remove('closed')}});window.addEventListener('click',(e)=>{let withinBoundaries=e.composedPath().includes(searchButton);if(!withinBoundaries){if(!e.composedPath().includes(searchDisplay)){if(!searchDisplay.classList.contains('.closed')){searchDisplay.classList.add('closed');searchDisplay.classList.remove('active')}else{searchDisplay.classList.toggle('active')}}}});searchInput.addEventListener('change',displayMathes);searchInput.addEventListener('keyup',displayMathes);function displayMathes(){clearPage(suggestions,'.city-item');const areaList=findMatches(this.value,data).map(place=>{const regex1=new RegExp(this.value,'gi');const listItem=createListItem(place,regex1);return listItem});areaList.forEach(match=>{append(suggestions,match)})}function findMatches(wordToMatch,array){wordToMatch!=''?searchClear.classList.add('active'):searchClear.classList.remove('active');return array.filter(place=>{const regex=new RegExp(wordToMatch,'gi');return place.name.match(regex)})}searchClear.addEventListener('click',()=>{searchInput.value='';displayMathes();searchClear.classList.remove('active')});function createListItem(object,regex){const nameMatch=object.name.match(regex);const name=createNode('span');searchInput.value==''?name.innerHTML=object.name:name.innerHTML=object.name.replace(regex,`<b>${nameMatch}</b>`);const item=createNode('div');item.classList.add('city-item');item.dataset.id=object.id;if(choiseList.find(element=>element.id==item.dataset.id))item.classList.add('active');append(item,name);if(object.state_id){const stateName=createNode('span');stateName.classList.add('state-name');stateName.textContent=data.find(e=>e.id==object.state_id).name;append(item,stateName)}item.addEventListener('click',switchChoise);return item}function switchChoise(){const item=this;const choise=data.find(element=>element.id==item.dataset.id);if(item.classList.contains('active')){removeChoise(item)}else{createChoiseItem(choise);item.classList.toggle('active');choiseList.push(choise)}}function createChoiseItem(data){const item=choiseArea.cloneNode(true).querySelector('.city-select');const name=item.querySelector('.city-select-name');const closeButton=item.querySelector('.city-select-clear');closeButton.dataset.id=data.id;closeButton.addEventListener('click',()=>{removeChoise(closeButton)});item.dataset.index=data.id;name.textContent=data.name;append(selectedArea,item)}function removeChoise(item){const selectedItem=selectedArea.querySelector(`[data-index='${item.dataset.id}']`);const selectedList=suggestions.querySelector(`[data-id='${item.dataset.id}']`);selectedList.classList.toggle('active');selectedItem.classList.toggle('closed');choiseList=removeArrayElement(choiseList,selectedItem.dataset.index);setTimeout(()=>{selectedItem.remove()},500)}saveButton.addEventListener('click',()=>{if(choiseList.length==0){choisedCities.textContent='Любой регион';setCookie(cookieName,'',{'max-age':-1});location.reload()}else{const area=choiseList.map(element=>element.name).join(', ');choisedCities.textContent=area;setCookie(cookieName,area);console.log(area);location.reload()}});function setCookie(name,value,options={}){options={path:'/',...options};if(options.expires instanceof Date){options.expires=options.expires.toUTCString()}let updatedCookie=name+"="+value;for(let optionKey in options){updatedCookie+="; "+optionKey;let optionValue=options[optionKey];if(optionValue!==true){updatedCookie+="="+optionValue}}document.cookie=updatedCookie}function openMenu(){menu.classList.remove('closed');overlay.classList.remove('closed');menu.classList.add('active');overlay.classList.add('active');sidebarContainer.classList.add('active')}hightEdButton.addEventListener('click',()=>{hightEdMenu.classList.toggle('active');hightEdMenu.classList.toggle('closed');middleEdMenu.classList.toggle('active');middleEdMenu.classList.toggle('closed');hightEdButton.classList.toggle('active');middleEdButton.classList.toggle('active')});middleEdButton.addEventListener('click',()=>{middleEdMenu.classList.toggle('active');middleEdMenu.classList.toggle('closed');hightEdMenu.classList.toggle('active');hightEdMenu.classList.toggle('closed');middleEdButton.classList.toggle('active');hightEdButton.classList.toggle('active')});sidebarButton.addEventListener('click',openMenu);overlay.addEventListener('click',(e)=>{let withinBoundaries=e.composedPath().includes(menu);if(!withinBoundaries){menu.classList.add('closed');overlay.classList.add('closed');overlay.classList.remove('active');menu.classList.remove('active');setTimeout(()=>{sidebarContainer.classList.remove('active')},500)}})}main();